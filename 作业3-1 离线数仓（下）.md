# 一、使用拉链表维护商家信息

## 1.1 建表

```sql
-- 创建商家信息表（增量表，分区表）
drop table if exists test.ods_trade_shops;
create table test.ods_trade_shops(
  `shopid` int COMMENT '商铺ID',
  `userid` int COMMENT '商铺联系人ID',
  `areaid` int COMMENT '区域ID',
  `shopname` string COMMENT '商铺名称',
  `shoplevel` int COMMENT '店铺等级',
  `status` int COMMENT '商铺状态',
  `createtime` string COMMENT '创建时间',
  `modifytime` string COMMENT '修改时间'
) COMMENT '商家信息表'
PARTITIONED BY (`dt` string)
row format delimited fields terminated by ',';

-- 创建商家信息维表（拉链表）
drop table if exists test.dim_trade_shops;
create table test.dim_trade_shops(
  `shopid` int COMMENT '商铺ID',
  `userid` int COMMENT '商铺联系人ID',
  `areaid` int COMMENT '区域ID',
  `shopname` string COMMENT '商铺名称',
  `shoplevel` int COMMENT '店铺等级',
  `status` int COMMENT '商铺状态',
  `createtime` string COMMENT '创建时间',
  `modifytime` string COMMENT '修改时间',
  `start_dt` string,
  `end_dt` string
) COMMENT '商家信息表';
```

## 1.2 加载数据

注：数据见附录

```sql
---导入数据到ods_trade_shops
load data local inpath '/data/lagoudw/data/shops0712.dat' overwrite into table test.ods_trade_shops partition(dt='2020-07-12');
-- 拉链表数据初始化
insert overwrite table test.dim_trade_shops
SELECT shopid,userid,areaid,shopname,shoplevel,STATUS,createtime,
modifytime,CASE WHEN modifytime IS NOT NULL THEN substr(modifytime, 0, 10) ELSE substr(createtime, 0, 10) END AS start_dt,'9999-12-31' AS end_dt 
FROM test.ods_trade_shops
WHERE dt='2020-07-12';
```



dim 层商家信息表数据加载脚本 /data/lagoudw/script/trade/dim_load_shops.sh

```shell
#! /bin/bash
source /etc/profile
if [ -n "$1" ]
then
    do_date=$1
else
    do_date=`date -d "-1 day" +%F`
fi
sql="
drop table if exists test.dim_trade_shops_tmp;
create table if not exists test.dim_trade_shops_tmp as
-- 新增的数据
SELECT
  shopid,
  userid,
  areaid,
  shopname,
  shoplevel,
  STATUS,
  createtime,
  modifytime,
  CASE WHEN modifytime IS NOT NULL THEN substr(modifytime, 0, 10)
  ELSE substr(createtime, 0, 10) END AS start_dt,
  '9999-12-31' AS end_dt 
FROM ods.ods_trade_shops WHERE dt='$do_date'
union all
-- 历史数据，未变化的不用处理；变化的数据将结束日期-1
SELECT
  B.shopid,
  B.userid,
  B.areaid,
  B.shopname,
  B.shoplevel,
  B.STATUS,
  B.createtime,
  B.modifytime,
  B.start_dt,
  CASE WHEN A.shopid IS NOT NULL THEN date_add('$do_date', -1) ELSE B.end_dt END AS end_dt 
FROM (select * from ods.ods_trade_shops where dt='$do_date') A
right join dim.dim_trade_shops B ON A.shopid=B.shopid;
-- 从临时表中查询数据插入到商家信息维表
insert overwrite table dim.dim_trade_shops select * from test.dim_trade_shops_tmp;
"
hive -e "$sql"
```



执行脚本加载数据

```shell
bash /data/lagoudw/script/trade/dim_load_shops.sh 2020-07-12
bash /data/lagoudw/script/trade/dim_load_shops.sh 2020-07-13
bash /data/lagoudw/script/trade/dim_load_shops.sh 2020-07-14
```



## 1.3 回滚数据

数据回滚到2020-07-13

```shell
drop table if exists test.shops_tmp;
create table if not exists test.shops_tmp as
select
	shopid,
  userid,
  areaid,
  shopname,
  shoplevel,
  STATUS,
  createtime,
  modifytime, start_dt, end_dt
from test.dim_trade_shops
where end_dt < '2020-07-13'
union all
select
	shopid,
  userid,
  areaid,
  shopname,
  shoplevel,
  STATUS,
  createtime,
  modifytime, start_dt, '9999-12-31' as end_date
from test.dim_trade_shops
where start_dt <= '2020-07-13' and end_dt >= '2020-07-13';

-- 将临时表中的数据插入商家维表,回滚完成
insert overwrite table test.dim_trade_shops select * from test.shops_tmp;
```



# 二、会员分析中计算沉默会员数和流失会员数

## 2.1 沉默会员统计

```sql
-- 只启动过一次，且安装时间是在7天前
select count(*) clientNum from dws.dws_member_start_day where dt <= date_add(current_date, -7) and device_id in (
select device_id from (select device_id, count(*) cnt from dws.dws_member_start_day group by device_id having cnt = 1) tmp
);
```

## 2.2 流失会员统计

```sql
-- 三十天内没有登陆过的会员
select count(distinct device_id) lossNum 
from dws.dws_member_start_day 
where device_id not in (
  select distinct device_id from dws.dws_member_start_day 
    where dt >= date_add(current_date, -30)
);
```



# 三、销售指标统计

## 3.0 日统计订单

```sql
-- 创建日统计表
drop table if exists dws.dws_trade_orders_day;
create table if not exists dws.dws_trade_orders_day(
  day_dt string comment '日期:yyyy-MM-dd',
  day_cnt decimal comment '日订单笔数',
  day_sum decimal comment '日订单总额'
) comment '日订单统计表';

-- 将统计结果插入日订单统计表中
insert overwrite table dws.dws_trade_orders_day
select dt, count(*) cnt, sum(totalMoney) total
from (
    select distinct orderid, dt, totalMoney 
    from ods.ods_trade_orders 
    where status >= 0 and dataFlag = '1'
) tmp group by dt;
```

## 3.1 每月订单统计

```sql
-- 创建月订单统计表
drop table if exists dws.dws_trade_orders_month;
create table if not exists dws.dws_trade_orders_month(
  trade_year string comment '年份',
  trade_month string comment '月份',
  month_cnt decimal comment '月订单总笔数',
  month_sum decimal comment '月订单总额'
) comment '月订单统计表';

insert overwrite table dws.dws_trade_orders_month
select substr(day_dt, 0, 4), substr(day_dt, 6, 2), sum(day_cnt) month_cnt, sum(day_sum) month_sum 
from dws.dws_trade_orders_day 
group by substr(day_dt, 0, 4), substr(day_dt, 6, 2);
```



## 3.2 每个季度的订单笔数和订单总额

```sql
-- 创建季度统计表
drop table if exists dws.dws_trade_orders_quarter;
create table if not exists dws.dws_trade_orders_quarter(
  trade_year string comment '年份',
  quarter string comment '季度',
  quarter_cnt decimal comment '季度订单总笔数',
  quarter_sum decimal comment '季度订单总额'
) comment '季度订单统计表';

insert overwrite table dws.dws_trade_orders_quarter
select trade_year, '1' as quarter, sum(month_cnt) quarter_cnt, sum(month_sum) quarter_sum 
from dws.dws_trade_orders_month where trade_month between '01' and '03'
group by trade_year
union all
select trade_year, '2' as quarter, sum(month_cnt) quarter_cnt, sum(month_sum) quarter_sum 
from dws.dws_trade_orders_month where trade_month between '04' and '06'
group by trade_year
union all
select trade_year, '3' as quarter, sum(month_cnt) quarter_cnt, sum(month_sum) quarter_sum 
from dws.dws_trade_orders_month where trade_month between '07' and '09'
group by trade_year
union all
select trade_year, '4' as quarter, sum(month_cnt) quarter_cnt, sum(month_sum) quarter_sum 
from dws.dws_trade_orders_month where trade_month between '10' and '12'
group by trade_year;	
```

## 3.3  节假日和工作日的订单统计

```sql
drop table if exists dim.dim_day_info;
create table if not exists dim.dim_day_info(
  day_dt string comment '日期',
  is_weekday tinyint comment '工作日标识：0：非工作日，1：工作日'
) comment '日期信息表';

-- 统计2020年休息日的订单笔数、订单总额
select nvl(sum(day_cnt), 0), nvl(sum(day_sum), 0) from dws.dws_trade_orders_day A left join dim.dim_day_info B on A.day_dt = B.day_dt where B.is_weekday = '0';

-- 统计2020年工作日的订单笔数、订单总额
select nvl(sum(day_cnt), 0), nvl(sum(day_sum), 0) from dws.dws_trade_orders_day A left join dim.dim_day_info B on A.day_dt = B.day_dt where B.is_weekday = '1';
```





# 附录

> /data/lagoudw/data/shops0712.dat

```
110050,1,100225,WSxxx营超市,1,1,2020-06-28,2020-07-12
110051,2,100236,新鲜xxx旗舰店,1,1,2020-06-28,2020-07-12
110052,3,100011,华为xxx旗舰店,1,1,2020-06-28,2020-07-12
110053,4,100159,小米xxx旗舰店,1,1,2020-06-28,2020-07-12
```

> /data/lagoudw/data/shops0713.dat

```
110052,3,100010,华为xxx旗舰店,2,1,2020-06-28,2020-07-13
110054,6,100050,OPxxx自营店,1,1,2020-06-28,2020-07-13
110055,7,100311,三只xxx鼠零食,1,1,2020-06-28,2020-07-13
```

> /data/lagoudw/data/shops0714.dat

```
110050,1,100225,WSxxx营超市,1,2,2020-06-28,2020-07-14
110054,6,100050,OPxxx自营店,2,1,2020-06-28,2020-07-14
110056,9,100225,乐居xxx日用品,1,1,2020-06-28,2020-07-14
110057,10,100211,同仁xxx大健康,1,1,2020-06-28,2020-07-14
```

